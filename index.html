<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonia Arcana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

    <style>
        /* ... (estils idèntics) ... */
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; overscroll-behavior: none; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; transition: background-color 0.3s ease; }
        .dot-gray { background-color: #6b7280; } .dot-green { background-color: #10b981; }
        .dot-yellow { background-color: #f59e0b; } .dot-red { background-color: #ef4444; }
        #custom-message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1050; display: none; font-size: 0.875rem; border: 1px solid rgba(255,255,255,0.1); }
        .message-success { background-color: #059669; color: #d1fae5; } .message-error { background-color: #b91c1c; color: #fee2e2; } .message-info { background-color: #1d4ed8; color: #dbeafe; }
        .input-styled { background-color: #374151; border: 1px solid #4b5563; color: #f3f4f6; border-radius: 0.375rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; width: 100%; }
        .input-styled:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); }
        .btn-disabled { background-color: #4b5563; cursor: not-allowed; opacity: 0.6; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 pt-8 sm:p-6">

    <div id="custom-message-box"></div>
    <div class="w-full max-w-xl">
        <header class="mb-6 text-left">
            </header>

        <main id="main-content">
            </main>

        <footer class="mt-10 text-center">
            <p id="version-display" class="text-xs text-gray-600 mt-2"></p>
        </footer>
    </div>

    <script type="module"> 
        const DEBUG = true;
        const log = (...args) => DEBUG && console.log(...args);
        const logError = (...args) => DEBUG && console.error(...args);

        const SCRIPT_VERSION = "V20250606_1614_ON_DEMAND_SYNTH";
        log(`DEBUG: Harmonia Arcana Script ${SCRIPT_VERSION} carregant...`); 
        
        let pipelineImport = null, recognition, isListening = false, accumulatedTranscript = "", analysisInterval;
        const ANALYSIS_INTERVAL_MS = 10000;
        let currentContext = "Calm";
        const MUSIC_CONTEXTS = ["Combat", "Exploration", "Tension", "Social", "Magic", "Stealth", "Calm"];
        let activeGameInspiration = "", classifierPipeline = null, isModelLoading = false;   
        
        function showCustomMessage(message, type = 'info', duration = 3000) { /* ... (idèntic) ... */ }
        function showScreen(screenId) { /* ... (idèntic) ... */ }
        function updateStatusDisplay(status, color = 'gray') { /* ... (idèntic) ... */ }
        
        // PUNT 2: NOU MUSIC MANAGER AMB CREACIÓ SOTA DEMANDA
        const musicManager = {
            synths: {}, // Es guardarà aquí un cop creat
            currentMusicLoop: null,
            isPaused: false,
            configs: {
                "Calm": {
                    creator: () => new Tone.PolySynth(Tone.Synth,{oscillator:{type:"sine"},envelope:{attack:2,decay:1,sustain:0.8,release:2},volume:-18}).toDestination(),
                    loop: (synth, t) => synth.triggerAttackRelease(["C4","E4","G4"],"4m",t),
                    interval: "4m", bpm: 60
                },
                "Combat": {
                    creator: () => new Tone.PolySynth(Tone.Synth,{oscillator:{type:"sawtooth"},envelope:{attack:0.01,decay:0.1,sustain:0.2,release:0.2},volume:-12}).toDestination(),
                    loop: (synth, t) => synth.triggerAttackRelease(["C2",["E2","G2"],"C2",["F2","A#2"]][Math.floor(t / 0.5) % 4],"8n",t),
                    interval: "4n", bpm: 140
                },
                "Exploration": {
                    creator: () => new Tone.FMSynth({harmonicity:1.5,modulationIndex:5,envelope:{attack:0.5,decay:0.1,sustain:0.8,release:1.5},volume:-15}).toDestination(),
                    loop: (synth, t) => synth.triggerAttackRelease(["C3","E3","G3","B3","G3","E3"][Math.floor(t) % 6],"1n",t),
                    interval: "1n", bpm: 70
                },
                "Tension": {
                    creator: () => new Tone.AMSynth({harmonicity:2,envelope:{attack:0.1,decay:1,sustain:0.1,release:1},volume:-18}).toDestination(),
                    loop: (synth, t) => synth.triggerAttackRelease("8n",t),
                    interval: "2n", bpm: 60
                },
                "Magic": {
                    creator: () => new Tone.FMSynth({harmonicity:3,modulationIndex:10,envelope:{attack:1,decay:0.5,sustain:1,release:2},volume:-14}).toDestination(),
                    loop: (synth, t) => synth.triggerAttackRelease(["A3","C#4","E4","G#4"][Math.floor(t/4) % 4],"2n",t),
                    interval: "1m", bpm: 65
                }
            },
            
            pause() { /* ... (idèntic) ... */ },
            resume() { /* ... (idèntic) ... */ },
            stop() { /* ... (idèntic) ... */ },
            updateToggleButton() { /* ... (idèntic) ... */ },

            play(context) {
                this.stop();
                currentContext = context;
                log(`Intentant reproduir context musical: ${context}`);

                const selectedConfig = this.configs[context] || this.configs["Calm"];
                
                // Pas 1: Comprova si el sintetitzador ja existeix.
                if (!this.synths[context]) {
                    log(`Sintetitzador per a '${context}' no trobat. Creant-lo ara...`);
                    try {
                        // Pas 2: Si no existeix, el crea utilitzant la seva funció 'creator'.
                        this.synths[context] = selectedConfig.creator();
                        log(`Sintetitzador per a '${context}' creat amb èxit.`);
                    } catch (error) {
                        logError(`Error creant el sintetitzador per a ${context}:`, error);
                        return; // Atura l'execució si no es pot crear el synth
                    }
                }
                
                const synthToUse = this.synths[context];

                this.currentMusicLoop = new Tone.Loop(t => selectedConfig.loop(synthToUse, t), selectedConfig.interval).start(0);
                Tone.Transport.bpm.value = selectedConfig.bpm;
                Tone.Transport.start();

                this.isPaused = false;
                document.getElementById('music-status').textContent = `Reproduint (${context})`;
                this.updateToggleButton();
                log(`Música ${context} iniciada (BPM: ${Tone.Transport.bpm.value})`);
            }
        };

        // La resta de funcions (setupSpeechRecognition, start/stopListening, etc.) romanen idèntiques
        async function setupSpeechRecognition() { /* ... */ }
        function startListening() { /* ... */ }
        function stopListening() { /* ... */ }
        async function processAccumulatedTranscript() { /* ... */ }
        async function analyzeTextForContext(text, inspiration = "") { /* ... */ }

        document.addEventListener('DOMContentLoaded', async () => { 
            document.getElementById('version-display').textContent = `Versió: ${SCRIPT_VERSION}`;
            await setupSpeechRecognition(); 
            showScreen('initial-setup-screen'); 

            document.getElementById('start-session-btn').addEventListener('click', async () => { 
                try {
                    if (Tone.context.state !== 'running') {
                       await Tone.start();
                       showCustomMessage("Sistema d'àudio activat!", "success");
                    }
                    
                    // Ja no cal inicialitzar els synths aquí. Es farà sota demanda.
                    
                    activeGameInspiration = document.getElementById('session-inspiration-input').value.trim();
                    document.getElementById('current-inspiration-display').textContent = activeGameInspiration ? `Inspiració: ${activeGameInspiration}` : 'Sense inspiració.';
                    showScreen('active-session-content');
                    
                    // La primera trucada a play crearà el synth "Calm"
                    musicManager.play("Calm");
                    
                    if (!classifierPipeline && !isModelLoading) {
                        analyzeTextForContext("iniciant sessió");
                    }
                } catch (error) {
                    logError("Error en iniciar la sessió:", error);
                    showCustomMessage("No s'ha pogut iniciar l'àudio. Interactua amb la pàgina i torna-ho a provar.", "error");
                }
            });

            document.getElementById('toggle-listening-btn').addEventListener('click', () => { if (isListening) stopListening(); else startListening(); });
            document.getElementById('skip-context-btn').addEventListener('click', processAccumulatedTranscript);
            document.getElementById('stop-music-btn').addEventListener('click', () => { if(musicManager.isPaused) musicManager.resume(); else musicManager.pause(); });
            document.getElementById('end-session-btn').addEventListener('click', () => { if (isListening) stopListening(); musicManager.stop(); showScreen('initial-setup-screen'); showCustomMessage("Sessió finalitzada.", "info"); });
        });
    </script>
</body>
</html>
