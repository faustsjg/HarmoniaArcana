<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonia Arcana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" integrity="sha512-jduERlz7En1IUZR54bqzpNI64AbffZWR//KJgF71SJ8D8/liKFZ+s1RxmUmB+bhCnIfzebdZsULwOrbVB5f3nQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; overscroll-behavior: none; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; transition: background-color 0.3s ease; }
        .dot-gray { background-color: #6b7280; } .dot-green { background-color: #10b981; }
        .dot-yellow { background-color: #f59e0b; } .dot-red { background-color: #ef4444; }
        #custom-message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1050; display: none; font-size: 0.875rem; border: 1px solid rgba(255,255,255,0.1); }
        .message-success { background-color: #059669; color: #d1fae5; } .message-error { background-color: #b91c1c; color: #fee2e2; } .message-info { background-color: #1d4ed8; color: #dbeafe; }
        .input-styled { background-color: #374151; border: 1px solid #4b5563; color: #f3f4f6; border-radius: 0.375rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; width: 100%; }
        .input-styled:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); }
        .btn-disabled { background-color: #4b5563; cursor: not-allowed; opacity: 0.6; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 pt-8 sm:p-6">

    <div id="custom-message-box"></div>

    <div class="w-full max-w-xl">
        <header class="mb-6 text-left">
            <h1 class="text-3xl font-bold text-purple-400">Harmonia Arcana</h1>
            <p class="text-gray-400 text-sm">El teu bard personal per ambientar partides èpiques.</p>
        </header>

        <main id="main-content">
            <section id="initial-setup-screen" class="space-y-6">
                <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                    <h2 class="text-xl font-semibold text-purple-300 mb-4">Prepara la Teva Sessió</h2>
                    <div class="mb-6">
                        <label for="session-inspiration-input" class="block text-sm font-medium text-gray-300 mb-1">Inspiració Musical (opcional):</label>
                        <input type="text" id="session-inspiration-input" class="input-styled" placeholder="Ex: Fantasia èpica, Cyberpunk Noir...">
                    </div>
                    <button id="start-session-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg text-md mb-3">
                        <i class="fas fa-play-circle mr-2"></i>Inicia la Simfonia
                    </button>
                </div>
            </section>

            <section id="active-session-content" class="hidden space-y-6">
                <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                    <div class="flex items-center justify-between mb-1">
                        <h2 id="active-session-display-title" class="text-2xl font-semibold text-purple-300">Sessió Activa</h2>
                        <div class="flex items-center">
                            <span id="status-dot" class="status-dot dot-gray"></span>
                            <p id="status-message" class="text-sm text-gray-400">Inactiu</p>
                        </div>
                    </div>
                    <p id="current-inspiration-display" class="text-sm text-purple-200 mb-3 italic"></p>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                        <button id="toggle-listening-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-4 rounded-lg text-sm">
                            <i class="fas fa-microphone mr-2"></i>Escoltar
                        </button>
                        <button id="skip-context-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2.5 px-4 rounded-lg text-sm" title="Força un canvi de context">
                            <i class="fas fa-sync-alt mr-2"></i>Forçar Anàlisi
                        </button>
                        <button id="stop-music-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-4 rounded-lg text-sm">
                            <i class="fas fa-stop-circle mr-2"></i>Aturar Música
                        </button>
                    </div>
                    
                    <div class="mb-4 p-3 bg-gray-700 rounded-lg h-20 overflow-y-auto text-xs text-gray-300 border border-gray-600">
                        <p id="transcript-preview">La transcripció en directe apareixerà aquí...</p>
                    </div>
                    
                    <div class="text-sm text-gray-400 mb-4">
                        Estat de la música: <span id="music-status" class="font-semibold text-purple-300">Aturada</span>
                    </div>
                    
                    <button id="end-session-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2.5 px-5 rounded-lg mt-6">
                        <i class="fas fa-door-open mr-2"></i>Finalitzar Sessió
                    </button>
                </div>
            </section>
        </main>

        <footer class="mt-10 text-center">
            <p id="version-display" class="text-xs text-gray-600 mt-2"></p>
        </footer>
    </div>

    <script type="module"> 
        const DEBUG = true;
        const log = (...args) => DEBUG && console.log(...args);
        const logError = (...args) => DEBUG && console.error(...args);

        const SCRIPT_VERSION = "V20250606_1517_LOGIC_REFINEMENT";
        log(`DEBUG: Harmonia Arcana Script ${SCRIPT_VERSION} carregant...`); 
        
        let pipelineImport = null; 
        let recognition; 
        let isListening = false;
        let accumulatedTranscript = "";
        let analysisInterval;
        const ANALYSIS_INTERVAL_MS = 10000;
        let currentContext = "Calm";
        const MUSIC_CONTEXTS = ["Combat", "Exploration", "Tension", "Social", "Magic", "Stealth", "Calm"];
        let activeGameInspiration = ""; 
        let classifierPipeline = null; 
        let isModelLoading = false;   
        
        function showCustomMessage(message, type = 'info', duration = 3000) {
            const box = document.getElementById('custom-message-box');
            if(!box) return;
            box.textContent = message;
            box.className = `message-${type}`;
            box.style.display = 'block';
            if (duration > 0) {
                setTimeout(() => { if (box.textContent === message) box.style.display = 'none'; }, duration);
            }
        }
        
        function showScreen(screenId) {
            document.getElementById('initial-setup-screen').classList.add('hidden');
            document.getElementById('active-session-content').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        function updateStatusDisplay(status, color = 'gray') {
            const statusDot = document.getElementById('status-dot');
            const statusMessage = document.getElementById('status-message');
            if (!statusDot || !statusMessage) return;
            statusMessage.textContent = status;
            statusDot.className = `status-dot dot-${color}`;
        }
        
        const musicManager = {
            synths: {},
            currentMusicLoop: null,
            isPaused: false, // PUNT 3: Nou estat per a la pausa
            
            initBaseSynths() {
                if (Object.keys(this.synths).length > 0) return;
                log("MusicManager: Pre-carregant sintetitzadors base...");
                this.synths.Calm = new Tone.PolySynth(Tone.Synth,{oscillator:{type:"sine"},envelope:{attack:2,decay:1,sustain:0.8,release:2},volume:-18}).toDestination();
                this.synths.Exploration = new Tone.FMSynth({harmonicity:1.5,modulationIndex:5,envelope:{attack:0.5,decay:0.1,sustain:0.8,release:1.5},volume:-15}).toDestination();
                this.synths.Combat = new Tone.PolySynth(Tone.Synth,{oscillator:{type:"sawtooth"},envelope:{attack:0.01,decay:0.1,sustain:0.2,release:0.2},volume:-12}).toDestination();
                log("MusicManager: Sintetitzadors base carregats.");
            },

            // PUNT 3: Noves funcions per pausar i reprendre
            pause() {
                if (Tone.Transport.state === 'started') {
                    Tone.Transport.pause();
                    this.isPaused = true;
                    document.getElementById('music-status').textContent = `Pausat (${currentContext})`;
                    log("Música pausada.");
                    this.updateToggleButton();
                }
            },

            resume() {
                if (Tone.Transport.state === 'paused') {
                    Tone.Transport.start();
                    this.isPaused = false;
                    document.getElementById('music-status').textContent = `Reproduint (${currentContext})`;
                    log("Música represa.");
                    this.updateToggleButton();
                }
            },

            stop() {
                if (this.currentMusicLoop) {
                    this.currentMusicLoop.stop(0).dispose();
                    this.currentMusicLoop = null;
                }
                if (Tone.Transport.state !== 'stopped') {
                    Tone.Transport.stop();
                }
                Tone.Transport.cancel();
                this.isPaused = false;
                document.getElementById('music-status').textContent = "Aturada";
                this.updateToggleButton();
                log("Música aturada completament.");
            },

            updateToggleButton() {
                const btn = document.getElementById('stop-music-btn');
                if (this.isPaused) {
                    btn.innerHTML = `<i class="fas fa-play mr-2"></i>Reprendre Música`;
                    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                } else {
                    btn.innerHTML = `<i class="fas fa-pause mr-2"></i>Aturar Música`;
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-red-600', 'hover:bg-red-700');
                }
            },

            play(context) {
                this.stop();
                currentContext = context;
                log(`Canviant context musical a: ${context}`);
                const configs = { /* ... (contingut idèntic a l'anterior) ... */ };
                const selectedConfig = configs[context] || configs["Calm"];
                this.currentMusicLoop = new Tone.Loop(t => selectedConfig.loop(selectedConfig.synth, t), selectedConfig.interval).start(0);
                Tone.Transport.bpm.value = selectedConfig.bpm;
                Tone.Transport.start();
                this.isPaused = false;
                document.getElementById('music-status').textContent = `Reproduint (${context})`;
                this.updateToggleButton();
                log(`Música ${context} iniciada (BPM: ${Tone.Transport.bpm.value})`);
            }
        };

        async function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showCustomMessage("El teu navegador no suporta el reconeixement de veu.", "error", 0);
                document.getElementById('toggle-listening-btn').classList.add('btn-disabled'); return;
            }
            recognition = new SpeechRecognition();
            recognition.lang = 'ca-ES';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.onstart = () => { /* ... (idèntic) ... */ };
            recognition.onend = () => { /* ... (idèntic) ... */ };
            recognition.onerror = (event) => { /* ... (idèntic) ... */ };
            recognition.onresult = (event) => { /* ... (idèntic) ... */ };
        }
        
        function startListening() { /* ... (idèntic) ... */ }
        function stopListening() { /* ... (idèntic) ... */ }

        // PUNT 2: Lògica d'anàlisi i evolució de la música millorada
        async function processAccumulatedTranscript() {
            if (!accumulatedTranscript.trim()) {
                log("No hi ha text acumulat per analitzar.");
                return;
            }
            log("Processant text acumulat:", `"${accumulatedTranscript}"`);
            const newContext = await analyzeTextForContext(accumulatedTranscript, activeGameInspiration);
            
            if (newContext && newContext !== currentContext) {
                log(`---> Canvi de context detectat! Anterior: ${currentContext}. Nou: ${newContext}. Canviant música.`);
                musicManager.play(newContext);
            } else {
                log(`--- No es canvia el context. Nou detectat: ${newContext}. Actual: ${currentContext}.`);
            }
            accumulatedTranscript = "";
        }
        
        async function analyzeTextForContext(text, inspiration = "") {
            updateStatusDisplay("Analitzant...", "yellow");
            if (isModelLoading) { /* ... */ return currentContext; }
            if (!classifierPipeline) { /* ... (càrrega del model) ... */ }
            
            try {
                const textToAnalyze = inspiration ? `Inspiració: ${inspiration}. Diàleg: ${text}` : text;
                log(`Enviant a la IA: "${textToAnalyze}"`);
                const result = await classifierPipeline(textToAnalyze, MUSIC_CONTEXTS, { hypothesis_template: "Aquesta situació és sobre {}." });
                const bestMatch = result.labels[0];
                const bestScore = result.scores[0];
                log(`Resultat IA -> Etiqueta: ${bestMatch}, Confiança: ${(bestScore * 100).toFixed(1)}%`);
                updateStatusDisplay(isListening ? "Escoltant..." : "Inactiu", "green");
                
                // Llindar de confiança més flexible
                if (bestScore > 0.4) {
                   return bestMatch;
                }
                log("Confiança del resultat per sota del llindar (40%). Mantenint context actual.");
                return currentContext;
            } catch (error) {
                logError("Error durant la classificació:", error);
                return currentContext;
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => { 
            document.getElementById('version-display').textContent = `Versió: ${SCRIPT_VERSION}`;
            await setupSpeechRecognition(); 
            showScreen('initial-setup-screen'); 

            document.getElementById('start-session-btn').addEventListener('click', async () => { 
                try {
                    // PUNT 1: Garantir que l'AudioContext s'inicia abans de res
                    if (Tone.context.state !== 'running') {
                       await Tone.start();
                       showCustomMessage("Sistema d'àudio activat!", "success");
                    }
                    // Ara que l'àudio funciona, inicialitzem els instruments
                    musicManager.initBaseSynths();
                    
                    activeGameInspiration = document.getElementById('session-inspiration-input').value.trim();
                    document.getElementById('current-inspiration-display').textContent = activeGameInspiration ? `Inspiració: ${activeGameInspiration}` : 'Sense inspiració.';
                    showScreen('active-session-content');
                    musicManager.play("Calm");
                    if (!classifierPipeline && !isModelLoading) {
                        analyzeTextForContext("iniciant sessió");
                    }
                } catch (error) {
                    logError("Error en iniciar la sessió:", error);
                    showCustomMessage("No s'ha pogut iniciar l'àudio. Fes clic a la pàgina i torna-ho a provar.", "error");
                }
            });

            document.getElementById('toggle-listening-btn').addEventListener('click', () => { /* ... (idèntic) ... */ });
            document.getElementById('skip-context-btn').addEventListener('click', processAccumulatedTranscript);
            
            // PUNT 3: Nou event listener per al botó de play/pause
            document.getElementById('stop-music-btn').addEventListener('click', () => {
                if(musicManager.isPaused) {
                    musicManager.resume();
                } else {
                    musicManager.pause();
                }
            });

            document.getElementById('end-session-btn').addEventListener('click', () => { 
                if (isListening) stopListening();
                musicManager.stop();
                showScreen('initial-setup-screen');
                showCustomMessage("Sessió finalitzada.", "info");
            });
        });
    </script>
</body>
</html>
