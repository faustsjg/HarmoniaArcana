<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonia Arcana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; 
            color: #f3f4f6; 
            overscroll-behavior: none;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; transition: background-color 0.3s ease; }
        .dot-gray { background-color: #6b7280; } .dot-green { background-color: #10b981; }
        .dot-yellow { background-color: #f59e0b; } .dot-red { background-color: #ef4444; }

        #custom-message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1050; display: none; font-size: 0.875rem; border: 1px solid rgba(255,255,255,0.1); }
        .message-success { background-color: #059669; color: #d1fae5; }
        .message-error { background-color: #b91c1c; color: #fee2e2; }
        .message-info { background-color: #1d4ed8; color: #dbeafe; }

        .input-styled { background-color: #374151; border: 1px solid #4b5563; color: #f3f4f6; border-radius: 0.375rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; width: 100%; }
        .input-styled:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); }
        
        .session-clip-btn { background-color: #4a5568; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s; font-size: 0.875rem; margin: 0.25rem; }
        .session-clip-btn:hover { background-color: #2d3748; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 pt-8 sm:p-6">

    <div id="custom-message-box"></div>

    <div id="new-game-name-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-purple-300 mb-4">Anomena la Nova Partida</h3>
            <input type="text" id="new-game-name-input" class="input-styled mb-4" placeholder="Nom de la partida...">
            <div class="mb-4">
                <label for="new-game-inspiration-input" class="block text-sm font-medium text-gray-300 mb-1">Inspiració Musical (opcional):</label>
                <input type="text" id="new-game-inspiration-input" class="input-styled" placeholder="Ex: El Senyor dels Anells, Hans Zimmer...">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-new-game-name-btn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 rounded-md text-sm">Cancel·lar</button>
                <button id="submit-new-game-name-btn" class="py-2 px-4 bg-green-600 hover:bg-green-700 rounded-md text-sm font-semibold">Confirmar i Iniciar</button>
            </div>
        </div>
    </div>

    <div class="w-full max-w-xl">
        <header class="mb-6 text-left">
            <h1 class="text-3xl font-bold text-purple-400">Harmonia Arcana</h1>
            <p class="text-gray-400 text-sm">El teu bard personal per ambientar partides èpiques.</p>
        </header>

        <main id="main-content">
            <section id="initial-setup-screen" class="space-y-6">
                <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                    <h2 class="text-xl font-semibold text-purple-300 mb-4">Prepara la Teva Sessió</h2>
                    <div class="mb-6">
                        <label for="session-inspiration-input" class="block text-sm font-medium text-gray-300 mb-1">Inspiració Musical (opcional):</label>
                        <input type="text" id="session-inspiration-input" class="input-styled" placeholder="Ex: Fantasia èpica, Cyberpunk Noir...">
                    </div>
                    <button id="start-session-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg text-md mb-3">
                        <i class="fas fa-play-circle mr-2"></i>Inicia la Simfonia
                    </button>
                </div>
            </section>

            <section id="active-session-content" class="hidden space-y-6">
                <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                    <div class="flex items-center justify-between mb-1">
                        <h2 id="active-session-display-title" class="text-2xl font-semibold text-purple-300">Sessió Activa</h2>
                        <div class="flex items-center">
                            <span id="status-dot" class="status-dot dot-gray"></span>
                            <p id="status-message" class="text-sm text-gray-400">Inactiu</p>
                        </div>
                    </div>
                    <p id="current-inspiration-display" class="text-sm text-purple-200 mb-3 italic"></p>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                        <button id="toggle-listening-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-4 rounded-lg text-sm">
                            <i class="fas fa-microphone mr-2"></i>Escoltar
                        </button>
                        <button id="skip-context-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2.5 px-4 rounded-lg text-sm" title="Força un canvi de context">
                            <i class="fas fa-sync-alt mr-2"></i>Forçar Anàlisi
                        </button>
                        <button id="stop-music-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-4 rounded-lg text-sm">
                            <i class="fas fa-stop-circle mr-2"></i>Aturar Música
                        </button>
                    </div>
                    
                    <div class="mb-4 p-3 bg-gray-700 rounded-lg h-20 overflow-y-auto text-xs text-gray-300 border border-gray-600">
                        <p id="transcript-preview">La transcripció en directe apareixerà aquí...</p>
                    </div>
                    
                    <div class="text-sm text-gray-400 mb-4">
                        Estat de la música: <span id="music-status" class="font-semibold text-purple-300">Aturada</span>
                    </div>

                    <div class="mb-4">
                        <h3 class="text-md font-medium text-purple-200 mb-2">Clips d'Escena Ràpids:</h3>
                         <button id="generate-session-clips-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg text-sm mb-3">
                            <i class="fas fa-wand-magic-sparkles mr-2"></i>Generar Clips d'Escena
                        </button>
                        <div id="session-clips-container" class="flex flex-wrap gap-2">
                             <p class="text-xs text-gray-400 w-full">Prem "Generar Clips" per obtenir suggeriments.</p>
                        </div>
                    </div>
                    
                    <button id="end-session-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2.5 px-5 rounded-lg mt-6">
                        <i class="fas fa-door-open mr-2"></i>Finalitzar Sessió
                    </button>
                </div>
            </section>
        </main>

        <footer class="mt-10 text-center">
            <p class="text-xs text-gray-500">L'anàlisi de veu i la generació de música són experimentals.</p>
            <p class="text-xs text-gray-500">Assegura't de permetre l'accés al micròfon i que la pàgina es carregui per HTTPS si tens problemes.</p>
        </footer>
    </div>

    <script type="module"> 
        console.log("DEBUG: El JavaScript principal s'està carregant com a mòdul."); 
        
        let pipelineImport = null; 
        let TransformersEnvImport = null;

        try {
            console.log("DEBUG: Intentant importar Transformers.js...");
            const transformersModule = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1');
            console.log("DEBUG: Transformers.js importat, mòdul:", transformersModule);

            if (transformersModule && typeof transformersModule.pipeline === 'function') {
                pipelineImport = transformersModule.pipeline;
                console.log("DEBUG: Funció 'pipeline' de Transformers.js assignada.");
            } else {
                 console.error("ERROR: La funció 'pipeline' NO S'HA POGUT ASSIGNAR des de Transformers.js.");
            }

            if (transformersModule && typeof transformersModule.env === 'object' && transformersModule.env !== null) {
                TransformersEnvImport = transformersModule.env;
                console.log("DEBUG: Objecte 'env' de Transformers.js assignat. Configurant per a models locals...");
                TransformersEnvImport.allowLocalModels = true;
                TransformersEnvImport.localModelPath = '/HarmoniaArcana/models/'; 
                TransformersEnvImport.allowRemoteModels = false; 
                console.log("DEBUG: Transformers.js configurat per a models locals a:", TransformersEnvImport.localModelPath);
            } else {
                console.error("ERROR: L'objecte 'env' NO S'HA POGUT ASSIGNAR des de Transformers.js o no és un objecte vàlid.");
            }
        } catch (e) {
            console.error("ERROR CRÍTIC DURANT LA IMPORTACIÓ/CONFIG DE TRANSFORMERS.JS:", e);
        }

        let recognition; 
        let isListening = false;
        let accumulatedTranscript = "";
        let analysisInterval;
        const ANALYSIS_INTERVAL_MS = 10000;
        let currentMusicLoop = null;
        let currentContext = "Calm";
        const MUSIC_CONTEXTS = ["Combat", "Exploration", "Tension", "Social", "Magic", "Stealth", "Calm"];
        let activeGameInspiration = ""; 
        let currentSessionClips = [];
        
        let classifierPipeline = null; 
        let isModelLoading = false;    
        let currentLoadingMessageId = null; 

        function showCustomMessage(message, type = 'info', duration = 3000, messageId = null) { /* ... (sense canvis) ... */ }
        function showScreen(screenIdToShow) { /* ... (sense canvis) ... */ }
        function updateMusicStatusDisplay(context, playing = true) { /* ... (sense canvis) ... */ }
        async function initializeTone() { /* ... (sense canvis) ... */ }
        function stopCurrentMusic() { /* ... (sense canvis) ... */ }
        function playMusicForContext(context) { /* ... (sense canvis) ... */ }
        async function checkMicPermission() { /* ... (sense canvis) ... */ }
        async function setupSpeechRecognition() { /* ... (sense canvis) ... */ }
        async function processAccumulatedTranscript() { /* ... (sense canvis) ... */ }
        function startListening() { /* ... (sense canvis) ... */ }
        function stopListening() { /* ... (sense canvis) ... */ }
        async function generateSceneClipsWithAI() { /* ... (sense canvis) ... */ }
        function renderSessionClipButtons() { /* ... (sense canvis) ... */ }
        async function analyzeTextForContext(text, inspiration = "") { /* ... (sense canvis, utilitza pipelineImport) ... */ }
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DEBUG: DOMContentLoaded - Iniciant configuració.");
            
            const initialSetupScreen = document.getElementById('initial-setup-screen');
            const activeSessionContent = document.getElementById('active-session-content'); 
            const sessionInspirationInput = document.getElementById('session-inspiration-input');
            const startSessionBtn = document.getElementById('start-session-btn');
            const activeSessionDisplayTitle = document.getElementById('active-session-display-title');
            const currentInspirationDisplay = document.getElementById('current-inspiration-display');
            const generateSessionClipsBtn = document.getElementById('generate-session-clips-btn');
            const toggleListeningBtn = document.getElementById('toggle-listening-btn');
            const skipContextBtn = document.getElementById('skip-context-btn');
            const stopMusicBtn = document.getElementById('stop-music-btn');
            const endSessionBtn = document.getElementById('end-session-btn');

            if (!initialSetupScreen || !activeSessionContent || !startSessionBtn || !toggleListeningBtn ) { 
                console.error("ERROR CRÍTIC: Un o més elements principals del DOM no s'han trobat dins de DOMContentLoaded. L'aplicació no funcionarà correctament.");
                showCustomMessage("Error crític en inicialitzar la interfície. Refresca la pàgina.", "error", 0);
                return; 
            }
            console.log("DEBUG: Tots els elements principals del DOM trobats dins de DOMContentLoaded.");
            
            setupSpeechRecognition(); 
            showScreen('initial-setup-screen'); 

            if (startSessionBtn) {
                console.log("DEBUG: Afegint event listener a 'start-session-btn'."); 
                startSessionBtn.addEventListener('click', async () => { 
                    console.log("DEBUG: Botó 'start-session-btn' CLICAT."); 
                    await initializeTone(); 
                    activeGameInspiration = sessionInspirationInput ? sessionInspirationInput.value.trim() : "";
                    
                    if (currentInspirationDisplay) {
                        currentInspirationDisplay.textContent = activeGameInspiration ? `Inspiració actual: ${activeGameInspiration}` : 'Cap inspiració musical definida.';
                    }
                    if (activeSessionDisplayTitle) activeSessionDisplayTitle.textContent = "Sessió Activa"; 
                    
                    showScreen('active-session-content');
                    
                    if (isListening) stopListening();
                    stopCurrentMusic();
                    currentContext = "Calm";
                    updateMusicStatusDisplay("Calm", false);
                    currentSessionClips = []; 
                    renderSessionClipButtons(); 
                    showCustomMessage(`Sessió iniciada! ${activeGameInspiration ? 'Amb inspiració: ' + activeGameInspiration : 'Sense inspiració específica.'}`, "success", 4000);
                    
                    if (!classifierPipeline && !isModelLoading && pipelineImport) { 
                       analyzeTextForContext("precàrrega inicial del model", activeGameInspiration)
                        .then(ctx => console.log("DEBUG: Precàrrega del model (o intent) finalitzada. Context inicial:", ctx))
                        .catch(err => console.error("DEBUG: Error durant la precàrrega del model:", err));
                    } else if (!pipelineImport) {
                        console.warn("DEBUG: No s'intenta precàrrega del model perquè pipelineImport no està definit.");
                    }
                });
            }

            if (generateSessionClipsBtn) { generateSessionClipsBtn.addEventListener('click', generateSceneClipsWithAI); }
            if (stopMusicBtn) { stopMusicBtn.addEventListener('click', () => { console.log("DEBUG: Botó 'Aturar Música' clicat."); stopCurrentMusic(); showCustomMessage("Música aturada manualment.", "info"); });}
            if (endSessionBtn) { endSessionBtn.addEventListener('click', () => { if (isListening) stopListening(); stopCurrentMusic(); if(sessionInspirationInput) sessionInspirationInput.value = ""; classifierPipeline = null; isModelLoading = false; pipelineImport = null; showScreen('initial-setup-screen');}); }
            if (toggleListeningBtn) { console.log("DEBUG: Afegint event listener a 'toggleListeningBtn'.");  toggleListeningBtn.addEventListener('click', () => {  console.log("DEBUG: Botó 'toggleListeningBtn' clicat! isListening:", isListening);  if (!isListening) { startListening();  } else { stopListening();  } }); }
            if (skipContextBtn) { skipContextBtn.addEventListener('click', () => {  console.log("DEBUG: Botó 'Forçar Anàlisi' clicat."); if (!isListening && !accumulatedTranscript.trim()) {  showCustomMessage("Inicia l'escolta o parla primer per poder forçar una anàlisi.", "info");  return; } if (!isListening && accumulatedTranscript.trim()) {  showCustomMessage("Forçant anàlisi del text anterior...", "info");  } else {  showCustomMessage("Forçant anàlisi del text acumulat...", "info");  } processAccumulatedTranscript();  }); }
        });

        // --- Funcions que no han canviat substancialment (només s'han eliminat alertes) ---
        // Aquestes funcions ja estan definides correctament més amunt.
        // No cal duplicar-les aquí.
        // showScreen = function(screenIdToShow) { ... };
        // updateMusicStatusDisplay = function(context, playing = true) { ... };
        // initializeTone = async function() { ... };
        // stopCurrentMusic = function() { ... };
        // playMusicForContext = function(context) { ... };
        // checkMicPermission = async function() { ... };
        // setupSpeechRecognition = async function() { ... };
        // processAccumulatedTranscript = async function() { ... };
        // startListening = function() { ... };
        // stopListening = function() { ... };
        // renderSessionClipButtons = function() { ... };
        // generateSceneClipsWithAI = async function() { ... };

    </script>
</body>
</html>
